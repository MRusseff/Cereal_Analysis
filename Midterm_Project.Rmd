---
title: "Technical Appendix Midterm"
author: "Mark Russeff & Loi Pham"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

```{r}
# Course: BUAN 5210
# Title: Technical Appendix Midterm
# Purpose: Midterm Project 
# Date: February 14, 2019
# Authors: Mark Russeff & Loi Pham
```


```{r echo = FALSE, message=FALSE, warning=FALSE}

# Clear environment of variables and functions
rm(list = ls(all = TRUE)) 

# Clear environmet of packages
if(is.null(sessionInfo()$otherPkgs) == FALSE)lapply(paste("package:", names(sessionInfo()$otherPkgs), sep=""), detach, character.only = TRUE, unload = TRUE)

```
```{r message = FALSE, warning = FALSE}

# Load packages
library(tidyverse)
library(GGally)
library(gridExtra)
library(kableExtra)
```

#Load and Review Data
```{r}
#Load data
mtp_product <- read.csv("mtp_product_data.csv")
mtp_sales <- read.csv("mtp_sales_data.csv")

#Check structure of the data
str(mtp_product)
str(mtp_sales)
```

##Join the Data Sets
```{r}
#Modify strings in UPC for join
mtp_product$UPC <- str_replace(mtp_product$UPC,"00-","")
mtp_sales$UPC <- str_replace_all(mtp_sales$UPC,"[.]","-")
  
#Join data frames into one by UPC
mtp <- mtp_sales %>%
  full_join(mtp_product, by = "UPC")

```

##Clean and Organize the Joined Data
```{r}
companies <- c("GENERAL MILLS", "KELLOGGS", "POST")

mtp <- mtp %>% 
  mutate(company = brand, cereal = brand)

for (pattern in companies) {
  mtp <- mtp %>% 
    mutate(company = if_else(str_detect(company, pattern),
                             pattern, as.character(company)),
           cereal = str_replace(cereal, pattern, ""), 
           cereal = str_replace(cereal, "TST CR", "TOAST CRUNCH"))
}

mtp <- mtp %>% 
  mutate(company = as.factor(str_to_title(company)),
         company = str_trim(str_replace(company, " ", "_")),
         cereal = as.factor(str_trim(str_to_title(cereal))),
         promo = as.factor(promo),
         
         revenue = price * units,
         price_volume = price / volume) %>% 
  select(company, cereal, price, units, volume, revenue, price_volume, promo, ad, package, week, iri_key)
```
# Univariate non-graphical

##Categorical data - summary
```{r}
# Inspect descriptive statistics of data
summary(mtp)

```

**Observations on the data**

- Kelloggs sells the most, followed by General Mills and Post.
- Kelloggs Frosted Flakes and Froot Loops are the most popular cereals. 
- Cinnamon Toast Crunch is General Mills' most popular cerearl.
- Price has a tight interquartile range but a very low min and a high max.
- Revenue is skewed due to some very large numbers.
- Because it is calculated from price, price per volume also has a tight interquartile range and high min/max values.
- Roughly 20% of the time there is an in-store promo.
- Only about 11.5% of the time are there ads being run.
- Ads and Promos make up a small percentage of total sales transactions.


##Categorical data - tabulation

###Company
```{r}
#Table of data by company.
mtp %>% 
  group_by(company) %>% 
  summarise(count = n(),
  mean_revenue = mean(revenue),
  mean_price = mean(price),
  mean_price_vol = mean(price_volume),
  mean_units = mean(units)) %>%
  arrange(desc(mean_revenue)) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

* Kelloggs has the highest number of sales but General Mills has the highest average revenue.
* It looks like General Mills may have more pricing power in the market.  

###Cereal

```{r}
#Table of data by cereal
mtp %>% 
  group_by(company, cereal) %>% 
  summarise(count = n(),
  mean_revenue = mean(revenue),
  mean_price = mean(price),
  mean_price_vol = mean(price_volume),
  mean_units = mean(units)) %>%
  arrange(desc(mean_revenue)) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

* General Mills strongest cereal brand in terms of average revenue is Cheerios.  
  + This is primarily from a high average units combined with a higher price per oz.  
  + Suggesting that Cheerios come in a smaller (lower volume) box or cup, so customers buy more units.  
* In terms of average revenue General Mills Cereals are performing well amoung their peers.

###Ad
```{r}
mtp %>% 
  group_by(company, ad) %>% 
  summarise(count = n(),
  mean_revenue = mean(revenue),
  mean_price = mean(price),
  mean_price_vol = mean(price_volume),
  mean_units = mean(units)) %>%
  arrange(desc(mean_revenue)) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```
* In terms of average revenue General Mills does better than their peers whether implimenting an Ad or not.  
  + Interestingly, no ad performs better than having just a medium/small ad.  
  + The medium/small ads for General Mills are underperforming compared to their peers.  
  + This could be due to the fact that the average price and average price per oz are considerably lower with a B ad.


###Promo
```{r}
mtp %>% 
  group_by(company, promo) %>% 
  summarise(count = n(),
  mean_revenue = mean(revenue),
  mean_price = mean(price),
  mean_price_vol = mean(price_volume),
  mean_units = mean(units)) %>%
  arrange(desc(mean_revenue)) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```
* In terms of average revenue General Mills is performing well compared to their peers whether they are running an instore promo or not.

###Ad and Promo
```{r}
mtp %>% 
  group_by(company, ad, promo) %>% 
  summarise(count = n(),
  mean_revenue = mean(revenue),
  mean_price = mean(price),
  mean_price_vol = mean(price_volume),
  mean_units = mean(units)) %>%
  arrange(desc(mean_revenue)) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

* We know that General Mills' medium/small ads are underperforming.  
  + The underperfoming ads appear to be only when combined with instore promos.  
  + For Kellogs and Post B ads with instore promos are thier best perfoming combination, yet not for General Mills.  
  + **Why are Medium/Small Ads not woking in combination with instore promotions?**


# Univariate graphical: categorical

##Company
```{r}

grid.arrange(
  #Graph Companies by number of sales.
   mtp %>% 
    group_by(company) %>% 
    summarise(count = n()) %>% 
    ggplot(aes(x = reorder(company, count),
             y = count)) + 
    geom_bar(stat = "identity", fill = "steelblue4",
             width = 0.8) +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
    ggtitle("Number of Sales by Company",
          subtitle = "Kelloggs has the highest number of sales.") +
    theme_classic() +
  theme(axis.text = element_text(face = "bold", size = 10),
        axis.title = element_blank(),
        axis.ticks.x = element_blank(),
        legend.title = element_text(face = "bold")) ,
  
  #Graph Companies by mean revenue.
  mtp %>% 
    group_by(company) %>% 
    summarise(mean_revenue = mean(revenue), count = n()) %>%
    ggplot(aes(x = reorder(company, count),
             y = mean_revenue)) + 
    geom_bar(stat = "identity", fill = "steelblue4",
             width = 0.8) +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
    ggtitle("Average Revenue by Company",
          subtitle = "General Mills has the highest average revenue.") +
    theme_classic() +
    theme(axis.text = element_text(face = "bold", size = 10),
        axis.title = element_blank(),
        axis.ticks.x = element_blank(),
        legend.title = element_text(face = "bold")) ,

ncol = 2
)
```

* We see that Kelloggs leads the idustry in number of sales but General Mills has a higher average revenue.  
  + This is good for General Mills, indicating that there is possible room to grow.  
  + Post lags in both sales and mean revenue.

##Cereal
```{r}
#Graphing the most popular cereal brands by number of sales.
mtp %>% 
    group_by(cereal) %>% 
    summarise(count = n()) %>% 
    ggplot(aes(x = reorder(cereal, count),
             y = count)) + 
    geom_bar(stat = "identity", fill = "steelblue4") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
    coord_flip() +
    xlab("Cereal") +
    ylab("") +
    ggtitle("Number of Sales by Cereal",
          subtitle = "Frosted Flakes and Froot Loops are best selling cereals") +
  theme_classic() +
  theme(axis.text = element_text(face = "bold", size = 9),
        axis.title.x = element_blank(),
        axis.title = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.title = element_text(face = "bold")) 
```

* Bassed on number of sales, Frosted Flakes and Froot Loops (both Kelloggs cereals) are the most popular cereal brands.  
* For the Genereal Mills brands Cinnamon Toast Crunch is the most popular.


```{r}
#Graphing mean revenue by cereal brand.
mtp %>% 
    group_by(cereal) %>% 
    summarise(mean_revenue = mean(revenue)) %>% 
    ggplot(aes(x = reorder(cereal, mean_revenue),
             y = mean_revenue)) + 
    geom_bar(stat = "identity", fill = "steelblue4") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
    coord_flip() +
    xlab("Cereal") +
    ylab("") +
    ggtitle("Average Revenue by Cereal",
          subtitle = "Cheerios has a very high average revenue compared to others") +
  theme_classic() +
  theme(axis.text = element_text(face = "bold", size = 9),
        axis.title.x = element_blank(),
        axis.title = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.title = element_text(face = "bold")) 
```
```{r}
#Graphing mean units by cereal
mtp %>% 
    group_by(cereal) %>% 
    summarise(mean_units = mean(units)) %>% 
    ggplot(aes(x = reorder(cereal, mean_units),
             y = mean_units)) + 
    geom_bar(stat = "identity", fill = "steelblue4") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
    coord_flip() +
    xlab("Cereal") +
    ylab("") +
    ggtitle("Average Units per sale by Cereal",
          subtitle = "Cheerios has a very high average revenue compared to others") +
  theme_classic() +
  theme(axis.text = element_text(face = "bold", size = 9),
        axis.title.x = element_blank(),
        axis.title = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.title = element_text(face = "bold")) 
```

* Graphically we can see what we intuitively know; that high mean units are closely related to high mean revenue.  
  + This relationship makes sense because units is part of the revenue calculation.  
  + Does higher mean units or higher mean price have the most significant affect on mean revenue?
* Cheerios has the highest average revenue per sale and highest units per sale. (General Mills brand).  
  + This likely accounts for much of General Mills success as a company at generating substantial revenues.


##Ad
```{r}
#Graphing mean units and mean revenue by ad, examining ad effectiveness.
grid.arrange(
  mtp %>% 
    mutate(ad = if_else(ad == "A", "Big", if_else(ad == "B", "Medium/Small", "None"))) %>% 
    group_by(ad) %>% 
    summarise(mean_units = mean(units)) %>% 
    ggplot(aes(x = reorder(ad, mean_units),
             y = mean_units)) + 
    geom_bar(stat = "identity", fill = "steelblue4") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
    ggtitle("Average # of Units Sold by Ad Type",
          subtitle = "What type of Ad moves the most units?") +
    theme_classic() +
    theme(axis.text = element_text(face = "bold", size = 10),
        axis.title = element_blank(),
        axis.ticks.x = element_blank(),
        legend.title = element_text(face = "bold")) ,

  mtp %>% 
    mutate(ad = if_else(ad == "A", "Big", if_else(ad == "B", "Medium/Small", "None"))) %>% 
    group_by(ad) %>% 
    summarise(mean_revenue = mean(revenue)) %>%
    ggplot(aes(x = reorder(ad, mean_revenue),
             y = mean_revenue)) + 
    geom_bar(stat = "identity", fill = "steelblue4") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
    ggtitle("Average Revenue by Ad Type",
          subtitle = "Do ads lead to larger revenue on average?") +
    theme_classic() +
    theme(axis.text = element_text(face = "bold", size = 10),
        axis.title = element_blank(),
        axis.ticks.x = element_blank(),
        legend.title = element_text(face = "bold")),
  

ncol = 2
)
```

* Running adds looks to slightly increase the average units sold but have very little affect on average revenue.  
* Why are ads not have more effect on mean revenue, while also increasing mean units sold.

##Promo
```{r}
#Graphing mean units and mean revenue for in-store promotions.
grid.arrange(
  mtp %>% 
    mutate(promo = if_else(promo == 1, "Yes", "No")) %>% 
    group_by(promo) %>% 
    summarise(mean_units = mean(units)) %>% 
    ggplot(aes(x = reorder(promo, mean_units),
             y = mean_units)) + 
    geom_bar(stat = "identity", fill = "steelblue4") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
    xlab("Instore Promos") +
    ylab("") +
    ggtitle("Average # of Units Sold by Promo",
          subtitle = "Running promos increases average units per sale.") +
    theme_classic() +
    theme(axis.text = element_text(face = "bold", size = 10),
        axis.title = element_blank(),
        axis.ticks.x = element_blank(),
        legend.title = element_text(face = "bold")),

  mtp %>% 
    mutate(promo = if_else(promo == 1, "Yes", "No")) %>% 
    group_by(promo) %>% 
    summarise(mean_revenue = mean(revenue)) %>%
    ggplot(aes(x = reorder(promo, mean_revenue),
             y = mean_revenue)) + 
    geom_bar(stat = "identity", fill = "steelblue4") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
    xlab("Instore Promos") +
    ylab("") +
    ggtitle("Average Revenue by Promo",
          subtitle = "Promos don't lead to much higher average revenue.") +
    theme_classic() +
    theme(axis.text = element_text(face = "bold", size = 10),
        axis.title = element_blank(),
        axis.ticks.x = element_blank(),
        legend.title = element_text(face = "bold")),
  

ncol = 2
)
```

* Similar as with the ads, instore promos look to slightly increase average units but have very little affect on average revenue.  


#Multi-variate graphical: quantitative
## Correlations

```{r, message = FALSE, error = FALSE}
ggpairs(subset(mtp, select = -c(iri_key, package, cereal, company, week)))
```

**Observations on correlations and multi-variate relationships.**  
- As would be expected the correlation between units and revenue is very high, very important factor for increasing revenue.
- There is a negative correlation between price and revenue, so raising prices will decrease revenue.  
- Price looks to be follow a somewhat normal distribution.  
- Units and Revenue appear to have a Chi-squarted distribution.  
- Both ad and promo have a lot of revenue values above the interquartile range, it should be okay but be cautious using mean.  


#Research Quesions
##Is General Mills underperforming the market when combining B ads (medium/small) with instore promotions, Why?  


```{r}

mod_all <- lm(log(revenue) ~ cereal + ad + promo + ad*promo + units, data = mtp)

# Review output
summary(mod_all)

mtp_gm <- mtp %>%
  filter(company == "General_Mills")
  
mod_gm <- lm(log(revenue) ~ cereal + ad + promo + ad*promo + units, data = mtp_gm)

# Review output
summary(mod_gm)
```

##As the market leader is there room for General Mills to imporve their in-store promotions?

```{r}
#Create a table of General Mills cereals and their mean revenue when an in-store promotion is happening.
mtp_gm %>% 
  group_by(cereal, promo) %>% 
  summarise(count = n(),
  mean_revenue = mean(revenue),
  mean_price = mean(price),
  mean_price_vol = mean(price_volume),
  mean_units = mean(units)) %>%
  
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

mtp_gm %>% 
  filter(cereal %in% c("Cocoa Puffs", "Kix")) %>%
  group_by(cereal, promo) %>% 
  summarise(count = n(),
  mean_revenue = mean(revenue),
  mean_price = mean(price),
  mean_price_vol = mean(price_volume),
  mean_units = mean(units)) %>%
  arrange(desc(promo)) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

+ Null Hypothesis 1: Revenue is the same across all cereals when running instore promotions.

```{r}

mtp_hyp1 <- mtp %>%
  filter(promo == 1) 

# Is revenue the same across brands?
t.test(mtp_hyp1$revenue[mtp_hyp1$company == "General_Mills"], mtp_hyp1$revenue[mtp_hyp1$company == "Kelloggs"])

t.test(mtp_hyp1$revenue[mtp_hyp1$company == "General_Mills"], mtp_hyp1$revenue[mtp_hyp1$company == "Post"])


```

```{r}
# 90% CI, get z-value for upper tail, use .95 since is one sided
z <- qnorm(.95)

# Incorporate CI into bar graph of means
mtp_hyp1 %>%
  group_by(company) %>%
  summarise(m = mean(revenue), sd = sd(revenue), 
            n = n(), ci = z * sd/sqrt(n)) %>%
  ggplot(aes(x = company, y = m)) +
  geom_bar(stat = "identity", position = "dodge", fill = "#9ecae1") +
  geom_errorbar(aes(ymin = m - ci, ymax = m + ci), 
                width = 0.5, position = position_dodge(0.9)) +
  theme_classic() +
  xlab("") +
  ylab("") +
  theme(axis.ticks.x = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.y = element_blank()) +
  ggtitle("Mean revenue is ")
```

+ Null Hypothesis: Revenue is the same across all General Mills cereals for in-store promotions.

```{r}
mtp_hyp2 <- mtp_gm %>%
  filter(promo == 1)

# Is revenue the same across brands?
#
t.test(mtp_hyp2$revenue[mtp_hyp2$cereal == "Kix"], mtp_hyp2$revenue[mtp_hyp2$cereal == "Cheerios"])

t.test(mtp_hyp2$revenue[mtp_hyp2$cereal == "Kix"], mtp_hyp2$revenue[mtp_hyp2$cereal == "Cinnamon Toast Crunch"])

t.test(mtp_hyp2$revenue[mtp_hyp2$cereal == "Kix"], mtp_hyp2$revenue[mtp_hyp2$cereal == "Cocoa Puffs"])

t.test(mtp_hyp2$revenue[mtp_hyp2$cereal == "Kix"], mtp_hyp2$revenue[mtp_hyp2$cereal == "Lucky Charms"])
```
```{r}
# 90% CI, get z-value for upper tail, use .95 since is one sided
z <- qnorm(.95)

# Incorporate CI into bar graph of means
mtp_hyp1 %>%
  group_by(company, cereal) %>%
  summarise(m = mean(revenue), sd = sd(revenue), 
            n = n(), ci = z * sd/sqrt(n)) %>%
  ggplot(aes(x = cereal, y = m, fill = reorder(company, m))) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = m - ci, ymax = m + ci), 
                width = 0.5, position = position_dodge(0.9)) +
  coord_flip() +
  theme_classic() +
  xlab("") +
  labs(fill = "") +
  theme(axis.ticks.x = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.y = element_blank()) +
  scale_fill_brewer() +
  ggtitle("Mean revenue is ")
```

```{r}
mtp_hyp1 %>%
  group_by(company, cereal) %>%
  summarise(m = mean(volume), sd = sd(volume), 
            n = n(), ci = z * sd/sqrt(n)) %>%
  ggplot(aes(x = cereal, y = m, fill = reorder(company, m), order = company)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = m - ci, ymax = m + ci), 
                width = 0.5, position = position_dodge(0.9)) +
  coord_flip() +
  theme_classic() +
  xlab("") +
  labs(fill = "") +
  theme(axis.ticks.x = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.y = element_blank()) +
  scale_fill_brewer() +
  ggtitle("Mean revenue is ")
```



```{r}
mtp_gm %>% 
  group_by(company, ad) %>% 
  summarise(count = n(),
  mean_revenue = mean(revenue),
  mean_price = mean(price),
  mean_price_vol = mean(price_volume),
  mean_units = mean(units)) %>%
  arrange(desc(mean_revenue)) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

mtp_gm %>% 
  filter(cereal == "Kix") %>%
  group_by(cereal, ad) %>% 
  summarise(count = n(),
  mean_revenue = mean(revenue),
  mean_price = mean(price),
  mean_price_vol = mean(price_volume),
  mean_units = mean(units)) %>%
  arrange(desc(mean_revenue)) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

```{r}
 

# Is revenue the same whether General Mills runs an add or not?
t.test(mtp_gm$units[mtp_gm$ad == "NONE"], mtp_gm$units[mtp_gm$ad != "NONE"])

# 
t.test(mtp_gm$revenue[mtp_gm$ad == "NONE"], mtp_gm$revenue[mtp_gm$ad != "NONE"])

```

```{r}
# 90% CI, get z-value for upper tail, use .95 since is one sided
z <- qnorm(.95)

# Incorporate CI into bar graph of means
mtp %>%
  group_by(company, ad) %>%
  summarise(m = mean(units), sd = sd(units), 
            n = n(), ci = z * sd/sqrt(n)) %>%
  ggplot(aes(x = company, y = m, fill = ad)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = m - ci, ymax = m + ci), 
                width = 0.5, position = position_dodge(0.9)) +
  theme_classic() +
  xlab("") +
  ylab("") +
  theme(axis.ticks.x = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.y = element_blank()) +
  scale_fill_brewer() +
  ggtitle("Mean Units is ")
```

```{r}
mtp_gm %>%
  group_by(cereal, ad) %>%
  summarise(m = mean(units), sd = sd(units), 
            n = n(), ci = z * sd/sqrt(n)) %>%
  ggplot(aes(x = cereal, y = m, fill = ad)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = m - ci, ymax = m + ci), 
                width = 0.5, position = position_dodge(0.9)) +
  theme_classic() +
  xlab("") +
  ylab("") +
  theme(axis.ticks.x = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.y = element_blank()) +
  scale_fill_brewer() +
  ggtitle("Mean Units is ")
```



